<?php

// $Id$

/**
 *@file
 * Suggests links between pages on your site
 *  
 * before publication, 
 * **error handling http://drupal.org/node/672504
 * **Way to flag as reviewed? Would that even be something you'd want?
 * **body['und'][0]['value'] consistent? what the hell is 'und'?
 * **needs to be more generalized: option to match between content types, fields
 * **move some internal functions to an include file?
 * **comments conform to standards
 * 
 * *Test line from d7dev
 */

/**
 * Implements hook_init()
 */
function ncpedia_linkrecs_init() {

  // Grab the maximum number of link suggestions allowed from a variable, or set default
  $max_suggestions = variable_get('ncpedia_linkrecs_max', 30);
  // Save the max as a variable
  variable_set('ncpedia_linkrecs_max', $max_suggestions);
  
  // Grab the maximum number of link suggestions allowed from a variable, or set default
  $context_length = variable_get('ncpedia_linkrecs_context_length', 60);
  // Save the max as a variable
  variable_set('ncpedia_linkrecs_context_length', $context_length);
}

/**
 * Implements hook_uninstall()
 */
function ncpedia_linkrecs_uninstall() {
  variable_del('ncpedia_linkrecs_max');
  variable_del('ncpedia_linkrecs_context_length');
}

/**
 * Implements hook_menu()
 */
function ncpedia_linkrecs_menu() {
  $items['admin/config/content/linkrecs'] = array(
    'title' => 'Link suggestions',
    'description' => 'Provides linking recommendations for edited pages.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ncpedia_linkrecs_page'),
    'access arguments' => array('access link suggestions page'),
    'file' => 'ncpedia_linkrecs.pages.inc',
    'file path' => drupal_get_path('module', 'ncpedia_linkrecs'),
  );
  $items['admin/config/content/linkrecs/settings'] = array(
    'title' => 'Link recommender settings',
    'description' => 'link recommender configuration',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ncpedia_linkrecs_admin_settings'),
    'access arguments' => array('administer link recommender'),
    'file' => 'ncpedia_linkrecs.admin.inc',
    'file path' => drupal_get_path('module', 'ncpedia_linkrecs'),
  );  
  return $items;
}

/**
 * Implements hook_permission().
 */
function ncpedia_linkrecs_permission() {
  return array(
    'administer link recommender' => array(
      'title' => t('Administer link suggestions module'),
      'description' => t('Perform administration tasks for link suggestions module.'),
    ),
    'access link suggestions page' => array(
      'title' => t('Access Linking Suggestions'),
      'description' => t('See suggested links when editing pages.'),
    ),
  );
}

/**
 * Implements hook_node_update()
 * 
 * Does a basic database scan to see if there are match candidates.
 * If so, provides a link for detailed review.
 */
function ncpedia_linkrecs_node_update($node) {
 
  //$title initialized as array of parsed titles - 
  //see ncpedia_linkrecs_parse_title documentation
  $title = ncpedia_linkrecs_parse_title($node->title);
  $match_found = FALSE;

  foreach ($title as $nt) {
    if ($match_found) {
      break;
    }
    //Pull titles of matches for count & approval
    $query = db_select('field_data_body', 'fdb');    
    $query->join('node','n','n.nid = fdb.entity_id');
    $query->fields('n', array('title', 'nid'))
    ->fields('fdb', array('body_value'))
    ->orderBy('title', 'ASC')
    ->condition('fdb.body_value', '%'.db_like($nt).'%', 'LIKE')
    ->addTag('node access');

    $result = $query->execute();

    foreach ($result as $row) {
      $existing_link_check = ncpedia_linkrecs_review_links($nt, ncpedia_linkrecs_get_tempbody($row->body_value));

      //Proceed with creating a link and contextual text, skipping:
      // * the entry itself (same nid)
      // * articles that don't pass link review
      if (($row->nid !== $node->nid) && (($existing_link_check == 'unlinked') || ($existing_link_check == 'external'))) {
        //If any items are found, present the link for further review, where all suggested links will be
        //available. No need to go beyond a preliminary list for this check, or even continue search 
        //once we've found something.
        $helpful_msg = t("Link suggestions available for "). $node->title . t(". Click to review (opens new window).");
        drupal_set_message(l($helpful_msg, 'admin/config/content/linkrecs/' . $node->nid, array('attributes' => array('target' => '_blank'))));
        $match_found = TRUE;
        break;
      }
    }
  }
}